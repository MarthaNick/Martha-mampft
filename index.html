<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weekly Meal Planner</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background-color: #f8f9fa;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        color: #2c3e50;
        margin-bottom: 30px;
        text-align: center;
        font-size: 2.2em;
      }

      .button-container {
        display: flex;
        gap: 20px;
        margin-bottom: 40px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .generate-btn,
      .surprise-btn,
      .next-week-btn,
      .prev-week-btn,
      .export-btn,
      .favorites-btn,
      .banned-btn,
      .save-btn,
      .load-btn {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      }

      .generate-btn:hover,
      .surprise-btn:hover,
      .next-week-btn:hover,
      .prev-week-btn:hover,
      .export-btn:hover,
      .favorites-btn:hover,
      .banned-btn:hover,
      .save-btn:hover,
      .load-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        background: linear-gradient(45deg, #2980b9, #1f618d);
      }

      .surprise-btn {
        background: linear-gradient(45deg, #f39c12, #e67e22);
        box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
      }

      .surprise-btn:hover {
        background: linear-gradient(45deg, #e67e22, #d35400);
        box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
      }

      .next-week-btn,
      .prev-week-btn {
        background: linear-gradient(45deg, #27ae60, #229954);
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
      }

      .next-week-btn:hover,
      .prev-week-btn:hover {
        background: linear-gradient(45deg, #229954, #1e8449);
        box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
      }

      .export-btn {
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
        box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
      }

      .export-btn:hover {
        background: linear-gradient(45deg, #8e44ad, #7d3c98);
        box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
      }

      .favorites-btn {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
      }

      .favorites-btn:hover {
        background: linear-gradient(45deg, #c0392b, #a93226);
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
      }

      .banned-btn {
        background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
      }

      .banned-btn:hover {
        background: linear-gradient(45deg, #7f8c8d, #6c7b7d);
        box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
      }

      .week-indicator {
        margin-bottom: 30px;
        padding: 15px 25px;
        background: #ecf0f1;
        border-radius: 15px;
        color: #2c3e50;
        font-weight: bold;
        font-size: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
      }

      .calendar-week {
        font-size: 14px;
        color: #7f8c8d;
        font-weight: normal;
      }

      .meals-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 25px;
        max-width: 1400px;
        width: 100%;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
      }
      
      @media (max-width: 1200px) {
        .meals-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      @media (max-width: 768px) {
        .meals-container {
          grid-template-columns: 1fr;
        }
      }

      .meals-container.show {
        opacity: 1;
        transform: translateY(0);
      }

      .meal-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .meal-card:hover {
        transform: translateY(-5px);
      }

      .meal-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background-color: #f0f0f0;
      }

      .meal-title {
        padding: 20px;
        font-size: 16px;
        color: #2c3e50;
        line-height: 1.4;
        text-align: center;
        font-weight: 500;
      }

      .rating-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        padding: 0 20px 20px;
      }

      .thumb-btn {
        background: none;
        border: 2px solid #ecf0f1;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .thumb-btn:hover {
        transform: scale(1.1);
      }

      .thumb-up {
        color: #27ae60;
      }

      .thumb-up:hover,
      .thumb-up.active {
        background: #27ae60;
        color: white;
        border-color: #27ae60;
      }

      .thumb-down {
        color: #e74c3c;
      }

      .thumb-down:hover,
      .thumb-down.active {
        background: #e74c3c;
        color: white;
        border-color: #e74c3c;
      }

      .list-container {
        display: none;
        max-width: 1200px;
        width: 100%;
        margin-top: 20px;
      }

      .list-container.show {
        display: block;
      }

      .list-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .list-header h2 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .back-btn {
        background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .back-btn:hover {
        background: linear-gradient(45deg, #7f8c8d, #6c7b7d);
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <h1>Weekly Meal Planner</h1>

    <div class="button-container">
      <button class="generate-btn" onclick="generateMeals()">
        Generate This Week's Meals
      </button>
      <button
        class="surprise-btn"
        onclick="surpriseMe()"
        id="surpriseBtn"
        style="display: none"
      >
        üé≤ Surprise Me
      </button>
      <button
        class="next-week-btn"
        onclick="nextWeek()"
        id="nextWeekBtn"
        style="display: none"
      >
        Next Week ‚Üí
      </button>
      <button
        class="prev-week-btn"
        onclick="previousWeek()"
        id="prevWeekBtn"
        style="display: none"
      >
        ‚Üê Previous Week
      </button>
      <button
        class="export-btn"
        onclick="exportShoppingList()"
        id="exportBtn"
        style="display: none"
      >
        üìã Export Shopping List
      </button>
      <button
        class="favorites-btn"
        onclick="showFavorites()"
        id="favoritesBtn"
        style="display: none"
      >
        ‚ù§Ô∏è Favorites
      </button>
      <button
        class="banned-btn"
        onclick="showBanned()"
        id="bannedBtn"
        style="display: none"
      >
        üö´ Banned
      </button>
      <button
        class="save-btn"
        onclick="saveState()"
        id="saveBtn"
        style="display: none"
      >
        üíæ Save State
      </button>
      <button
        class="load-btn"
        onclick="loadState()"
        id="loadBtn"
      >
        üìÇ Load State
      </button>
    </div>

    <div class="week-indicator" id="weekIndicator" style="display: none">
      <span id="weekText"></span>
    </div>

    <div class="meals-container" id="mealsContainer"></div>

    <script src="meals.js"></script>
    <div class="list-container" id="favoritesContainer">
      <div class="list-header">
        <h2>‚ù§Ô∏è Favorite Meals</h2>
        <button class="back-btn" onclick="showMainView()">
          ‚Üê Back to Meal Planner
        </button>
      </div>
      <div class="meals-container show" id="favoritesMealsGrid"></div>
    </div>

    <div class="list-container" id="bannedContainer">
      <div class="list-header">
        <h2>üö´ Banned Meals</h2>
        <button class="back-btn" onclick="showMainView()">
          ‚Üê Back to Meal Planner
        </button>
      </div>
      <div class="meals-container show" id="bannedMealsGrid"></div>
    </div>

    <script>

              let currentWeek = 0;
              let weeklyMeals = [];
              let usedMeatMeals = [];
              let usedVegetarianMeals = [];
              let allWeeklyMeals = {}; // Store meals for all weeks
              let favorites = [];
              let banned = [];
              let mealRatings = {}; // Store ratings for each meal
              let startingCalendarWeek = getCurrentWeekNumber(); // Track when meal planning started

              function getCurrentWeekNumber() {
                  const now = new Date();
                  const firstDayOfYear = new Date(now.getFullYear(), 0, 1);
                  const pastDaysOfYear = (now - firstDayOfYear) / 86400000;
                  return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
              }

              function getCalendarWeekForMealWeek(mealWeek) {
                  const currentCalendarWeek = getCurrentWeekNumber();
                  const targetWeek = currentCalendarWeek + mealWeek;

                  // Handle year overflow (weeks 53+ should wrap to next year)
                  if (targetWeek > 52) {
                      return targetWeek - 52;
                  }
                  return targetWeek;
              }

              function shuffleArray(array) {
                  const shuffled = [...array];
                  for (let i = shuffled.length - 1; i > 0; i--) {
                      const j = Math.floor(Math.random() * (i + 1));
                      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                  }
                  return shuffled;
              }

              function generateWeeklyMeals() {
                  // Remove banned meals from available options
                  const availableMeatMeals = meatMeals.filter(meal =>
                      !usedMeatMeals.includes(meal.title) && !banned.includes(meal.title)
                  );
                  const availableVegetarianMeals = vegetarianMeals.filter(meal =>
                      !usedVegetarianMeals.includes(meal.title) && !banned.includes(meal.title)
                  );

                  // Check if we need to include favorite meals (after 4 weeks)
                  let priorityMeatMeals = availableMeatMeals;
                  let priorityVegetarianMeals = availableVegetarianMeals;

                  if (Object.keys(allWeeklyMeals).length >= 4) {
                      // After 4 weeks, prioritize favorites
                      const favoriteMeatMeals = availableMeatMeals.filter(meal => favorites.includes(meal.title));
                      const favoriteVegetarianMeals = availableVegetarianMeals.filter(meal => favorites.includes(meal.title));

                      if (favoriteMeatMeals.length > 0) priorityMeatMeals = favoriteMeatMeals;
                      if (favoriteVegetarianMeals.length > 0) priorityVegetarianMeals = favoriteVegetarianMeals;
                  }

                  // Reset used meals if we've exhausted options
                  if (priorityMeatMeals.length === 0) {
                      usedMeatMeals = [];
                      priorityMeatMeals = meatMeals.filter(meal => !banned.includes(meal.title));
                  }
                  if (priorityVegetarianMeals.length < 3) {
                      usedVegetarianMeals = [];
                      priorityVegetarianMeals = vegetarianMeals.filter(meal => !banned.includes(meal.title));
                  }

                  // Required constraints that must be covered each week
                  const requiredConstraints = [
                      'seasonal', 'salad', 'oven', 'pasta', 'beans_lentils',
                      'eggs', 'dairy', 'grain', 'green_vegetable'
                  ];

                  // Select 1 meat meal
                  const selectedMeatMeal = shuffleArray(priorityMeatMeals)[0];
                  usedMeatMeals.push(selectedMeatMeal.title);

                  // Track which constraints and regions are already covered by the meat meal
                  let coveredConstraints = [...selectedMeatMeal.constraints];
                  let coveredRegions = [selectedMeatMeal.region];
                  let selectedMeals = [selectedMeatMeal];

                  // Select 3 vegetarian meals that cover remaining constraints and ensure regional diversity
                  let remainingVegetarianMeals = [...priorityVegetarianMeals];

                  for (let i = 0; i < 3; i++) {
                      // Find uncovered required constraints
                      const uncoveredConstraints = requiredConstraints.filter(c => !coveredConstraints.includes(c));
                      
                      // Prioritize meals from uncovered regions to ensure at least 2 regions per week
                      const uncoveredRegionMeals = remainingVegetarianMeals.filter(meal =>
                          !coveredRegions.includes(meal.region)
                      );
                      
                      let candidateMeals = remainingVegetarianMeals;
                      
                      // If we have less than 2 regions covered and there are uncovered region meals, prioritize them
                      if (coveredRegions.length < 2 && uncoveredRegionMeals.length > 0) {
                          candidateMeals = uncoveredRegionMeals;
                      }

                      if (uncoveredConstraints.length > 0) {
                          // Prioritize meals that cover uncovered constraints
                          const constraintPriorityMeals = candidateMeals.filter(meal =>
                              meal.constraints.some(c => uncoveredConstraints.includes(c))
                          );

                          if (constraintPriorityMeals.length > 0) {
                              // Sort by how many uncovered constraints each meal covers
                              constraintPriorityMeals.sort((a, b) => {
                                  const aScore = a.constraints.filter(c => uncoveredConstraints.includes(c)).length;
                                  const bScore = b.constraints.filter(c => uncoveredConstraints.includes(c)).length;
                                  return bScore - aScore;
                              });

                              const selectedMeal = constraintPriorityMeals[0];
                              selectedMeals.push(selectedMeal);
                              coveredConstraints.push(...selectedMeal.constraints);
                              if (!coveredRegions.includes(selectedMeal.region)) {
                                  coveredRegions.push(selectedMeal.region);
                              }
                              usedVegetarianMeals.push(selectedMeal.title);
                              remainingVegetarianMeals = remainingVegetarianMeals.filter(m => m.title !== selectedMeal.title);
                              continue;
                          }
                      }

                      // If no constraint priority meals, select from candidate meals
                      if (candidateMeals.length > 0) {
                          const randomMeal = shuffleArray(candidateMeals)[0];
                          selectedMeals.push(randomMeal);
                          coveredConstraints.push(...randomMeal.constraints);
                          if (!coveredRegions.includes(randomMeal.region)) {
                              coveredRegions.push(randomMeal.region);
                          }
                          usedVegetarianMeals.push(randomMeal.title);
                          remainingVegetarianMeals = remainingVegetarianMeals.filter(m => m.title !== randomMeal.title);
                      }
                  }

                  // Shuffle the final selection so meat isn't always first
                  return shuffleArray(selectedMeals);
              }

              function displayMeals(meals) {
                  const container = document.getElementById('mealsContainer');

                  // Hide container first
                  container.classList.remove('show');

                  setTimeout(() => {
                      container.innerHTML = '';

                      meals.forEach((meal, index) => {
                          const mealCard = document.createElement('div');
                          mealCard.className = 'meal-card';

                          const rating = mealRatings[meal.title] || '';
                          const thumbUpActive = rating === 'up' ? 'active' : '';
                          const thumbDownActive = rating === 'down' ? 'active' : '';

                          mealCard.innerHTML = `
                              <img src="${meal.image}" alt="${meal.title}" class="meal-image">
                              <div class="meal-title">
                                  ${meal.title}
                              </div>
                              <div class="rating-buttons">
                                  <button class="thumb-btn thumb-up ${thumbUpActive}" onclick="rateMeal('${meal.title}', 'up')">
                                      üëç
                                  </button>
                                  <button class="thumb-btn thumb-down ${thumbDownActive}" onclick="rateMeal('${meal.title}', 'down')">
                                      üëé
                                  </button>
                              </div>
                          `;

                          container.appendChild(mealCard);
                      });

                      // Show container with animation
                      setTimeout(() => {
                          container.classList.add('show');
                      }, 100);
                  }, 300);
              }

              function rateMeal(mealTitle, rating) {
                  // Update rating
                  mealRatings[mealTitle] = rating;

                  if (rating === 'up') {
                      // Add to favorites if not already there
                      if (!favorites.includes(mealTitle)) {
                          favorites.push(mealTitle);
                      }
                      // Remove from banned if it was there
                      banned = banned.filter(title => title !== mealTitle);
                  } else if (rating === 'down') {
                      // Add to banned if not already there
                      if (!banned.includes(mealTitle)) {
                          banned.push(mealTitle);
                      }
                      // Remove from favorites if it was there
                      favorites = favorites.filter(title => title !== mealTitle);
                  }

                  // Update button states
                  updateRatingButtons();

                  // Show favorites/banned buttons
                  document.getElementById('favoritesBtn').style.display = favorites.length > 0 ? 'inline-block' : 'none';
                  document.getElementById('bannedBtn').style.display = banned.length > 0 ? 'inline-block' : 'none';
              }

              function updateRatingButtons() {
                  const thumbButtons = document.querySelectorAll('.thumb-btn');
                  thumbButtons.forEach(button => {
                      const mealTitle = button.onclick.toString().match(/'([^']+)'/)[1];
                      const rating = mealRatings[mealTitle];

                      button.classList.remove('active');
                      if ((button.classList.contains('thumb-up') && rating === 'up') ||
                          (button.classList.contains('thumb-down') && rating === 'down')) {
                          button.classList.add('active');
                      }
                  });
              }

              function updateWeekDisplay() {
                  const calendarWeek = getCalendarWeekForMealWeek(currentWeek);
                  document.getElementById('weekText').textContent = `Calendar Week ${calendarWeek}`;
              }

              function generateMeals() {
                  currentWeek = 0;
                  startingCalendarWeek = getCurrentWeekNumber();
                  usedMeatMeals = [];
                  usedVegetarianMeals = [];
                  allWeeklyMeals = {}; // Reset all weekly meals

                  const selectedMeals = generateWeeklyMeals();
                  allWeeklyMeals[0] = selectedMeals; // Store week 0 meals
                  displayMeals(selectedMeals);

                  // Show navigation and indicator buttons
                  document.getElementById('nextWeekBtn').style.display = 'inline-block';
                  document.getElementById('prevWeekBtn').style.display = 'none';
                  document.getElementById('weekIndicator').style.display = 'block';
                  document.getElementById('exportBtn').style.display = 'inline-block';
                  document.getElementById('favoritesBtn').style.display = favorites.length > 0 ? 'inline-block' : 'none';
                  document.getElementById('bannedBtn').style.display = banned.length > 0 ? 'inline-block' : 'none';
                  document.getElementById('surpriseBtn').style.display = favorites.length >= 4 ? 'inline-block' : 'none';
                  document.getElementById('saveBtn').style.display = 'inline-block';
                  updateWeekDisplay();
              }

              function surpriseMe() {
                  if (favorites.length < 4) {
                      alert('You need at least 4 favorite meals to use Surprise Me!');
                      return;
                  }

                  currentWeek = 0;
                  startingCalendarWeek = getCurrentWeekNumber();
                  allWeeklyMeals = {};

                  // Get all favorite meals
                  const allMeals = [...meatMeals, ...vegetarianMeals];
                  const favoriteMeals = allMeals.filter(meal => favorites.includes(meal.title));

                  // Try to maintain 1 meat + 3 vegetarian structure if possible
                  const favoriteMeatMeals = favoriteMeals.filter(meal => meal.type === 'meat');
                  const favoriteVegetarianMeals = favoriteMeals.filter(meal => meal.type === 'vegetarian');

                  let selectedMeals = [];

                  if (favoriteMeatMeals.length >= 1 && favoriteVegetarianMeals.length >= 3) {
                      // Perfect balance possible
                      selectedMeals.push(shuffleArray(favoriteMeatMeals)[0]);
                      selectedMeals.push(...shuffleArray(favoriteVegetarianMeals).slice(0, 3));
                  } else {
                      // Just pick any 4 favorites
                      selectedMeals = shuffleArray(favoriteMeals).slice(0, 4);
                  }

                  allWeeklyMeals[0] = selectedMeals;
                  displayMeals(selectedMeals);

                  // Show navigation buttons
                  document.getElementById('nextWeekBtn').style.display = 'inline-block';
                  document.getElementById('prevWeekBtn').style.display = 'none';
                  document.getElementById('weekIndicator').style.display = 'block';
                  document.getElementById('exportBtn').style.display = 'inline-block';
                  document.getElementById('saveBtn').style.display = 'inline-block';
                  updateWeekDisplay();
              }

              function exportShoppingList() {
                  if (!allWeeklyMeals[currentWeek]) {
                      alert('No meals generated for this week!');
                      return;
                  }

                  const weekMeals = allWeeklyMeals[currentWeek];
                  const calendarWeek = getCalendarWeekForMealWeek(currentWeek);

                  // Define ingredient categories in typical supermarket order
                  const categories = {
                      'Fresh Vegetables & Herbs': ['asparagus', 'spinach', 'arugula', 'rucola', 'kale', 'brussels sprouts', 'cabbage', 'peas', 'broccoli', 'zucchini', 'bell peppers', 'eggplants', 'cucumber', 'tomatoes', 'cherry tomatoes', 'onions', 'red onion', 'garlic', 'ginger', 'carrots', 'pumpkin', 'winter squash', 'seasonal vegetables', 'spring vegetables', 'seasonal root vegetables', 'mixed seasonal greens', 'mixed greens', 'basil', 'parsley', 'chives', 'thyme', 'rosemary', 'sage', 'oregano', 'dill', 'mint', 'herbs', 'seasonal herbs', 'fresh herbs', 'bok choy', 'scallions', 'cilantro', 'collard greens', 'callaloo leaves', 'wakame seaweed', 'nori seaweed', 'radishes', 'celery', 'bean sprouts', 'green papaya'],
                      'Fruits': ['lemons', 'apples', 'rhubarb', 'plums', 'lime', 'mixed berries', 'avocados', 'korean pear', 'dried apricots', 'dried cranberries', 'dried fruits'],
                      'Meat & Fish': ['salmon fillets', 'chicken breast', 'cod fillets', 'turkey breast', 'duck breast', 'pork tenderloin', 'veal shanks', 'kielbasa sausage', 'ground beef', 'ground pork', 'veal cutlets', 'beef brisket', 'lamb shoulder', 'beef short ribs', 'chorizo', 'chicken thighs', 'beef ribeye', 'chicken pieces', 'prosciutto', 'fresh clams', 'sea bass fillets', 'beef stew meat', 'pork chops', 'halibut fillets', 'trout fillets', 'swordfish steaks', 'rack of lamb', 'sole fillets', 'pork shoulder', 'beef roast', 'lamb shanks', 'lamb chops'],
                      'Dairy & Eggs': ['eggs', 'butter', 'milk', 'heavy cream', 'mascarpone cheese', 'ricotta cheese', 'mozzarella cheese', 'parmesan cheese', 'gruyere cheese', 'goat cheese', 'feta cheese', 'cheddar cheese', 'sour cream', 'cream cheese', 'monterey jack cheese', 'soft-boiled eggs', 'hard-boiled eggs'],
                      'Grains & Bread': ['wild rice', 'quinoa', 'pearl barley', 'brown rice', 'bulgur', 'basmati rice', 'arborio rice', 'pasta', 'lasagna sheets', 'bread', 'pie crust', 'puff pastry', 'breadcrumbs', 'flour', 'short grain rice', 'white rice', 'jasmine rice', 'couscous', 'rye bread', 'sourdough bread', 'naan bread', 'pita bread', 'injera bread', 'macaroni', 'spaetzle', 'ramen noodles', 'orzo pasta', 'egg noodles', 'corn tortillas', 'pierogi'],
                      'Legumes & Nuts': ['chickpeas', 'green lentils', 'red lentils', 'white beans', 'black beans', 'pine nuts', 'pumpkin seeds', 'kidney beans', 'black lentils', 'mixed lentils', 'walnuts', 'peanuts', 'sliced almonds'],
                      'Pantry & Condiments': ['olive oil', 'vegetable oil', 'salt', 'black pepper', 'nutmeg', 'curry powder', 'dijon mustard', 'balsamic vinegar', 'red wine vinegar', 'honey', 'sugar', 'tomato sauce', 'tomatoes (canned)', 'coconut cream', 'white wine', 'vegetable broth', 'coconut milk', 'soy sauce', 'sesame oil', 'teriyaki sauce', 'miso paste', 'garam masala', 'jerk seasoning', 'berbere spice', 'moroccan spice blend', 'enchilada sauce', 'bbq sauce', 'maple syrup', 'sumac', 'tomato salsa', 'fish sauce', 'gochujang', 'sesame seeds', 'lingonberry jam', 'red wine', 'beef broth', 'chicken broth', 'kimchi', 'sauerkraut', 'capers', 'kalamata olives', 'preserved lemons', 'tomato paste', 'gingersnap cookies', 'bay leaves', 'juniper berries', 'caraway seeds', 'cumin', 'turmeric', 'paprika', 'allspice', 'vanilla extract', 'baking powder', 'powdered sugar', 'brown sugar', 'palm sugar', 'scotch bonnet pepper', 'thai chilies', 'pickled beets']
                  };

                  // Aggregate all ingredients
                  const ingredientsList = {};
                  const categorizedIngredients = {};

                  // Initialize categories
                  Object.keys(categories).forEach(category => {
                      categorizedIngredients[category] = {};
                  });
                  categorizedIngredients['Other'] = {};

                  weekMeals.forEach(meal => {
                      if (meal.ingredients) {
                          Object.entries(meal.ingredients).forEach(([ingredient, amount]) => {
                              if (ingredientsList[ingredient]) {
                                  // If ingredient already exists, note multiple amounts
                                  if (!ingredientsList[ingredient].includes(amount)) {
                                      ingredientsList[ingredient] += ` + ${amount}`;
                                  }
                              } else {
                                  ingredientsList[ingredient] = amount;
                              }
                          });
                      }
                  });

                  // Categorize ingredients
                  Object.entries(ingredientsList).forEach(([ingredient, amount]) => {
                      let found = false;
                      const lowerIngredient = ingredient.toLowerCase();
                      
                      for (const [category, keywords] of Object.entries(categories)) {
                          if (keywords.some(keyword => lowerIngredient.includes(keyword.toLowerCase()) || keyword.toLowerCase().includes(lowerIngredient))) {
                              categorizedIngredients[category][ingredient] = amount;
                              found = true;
                              break;
                          }
                      }
                      
                      if (!found) {
                          categorizedIngredients['Other'][ingredient] = amount;
                      }
                  });

                  // Create PDF content
                  let pdfContent = `
      <!DOCTYPE html>
      <html>
      <head>
          <meta charset="UTF-8">
          <style>
              body {
                  font-family: Arial, sans-serif;
                  margin: 20px;
                  line-height: 1.4;
              }
              h1 {
                  color: #2c3e50;
                  border-bottom: 3px solid #3498db;
                  padding-bottom: 10px;
              }
              h2 {
                  color: #27ae60;
                  margin-top: 30px;
                  margin-bottom: 15px;
              }
              h3 {
                  color: #3498db;
                  margin-top: 25px;
                  margin-bottom: 10px;
                  border-left: 4px solid #3498db;
                  padding-left: 10px;
              }
              .meal-list {
                  background: #f8f9fa;
                  padding: 15px;
                  border-radius: 8px;
                  margin: 20px 0;
              }
              .meal-item {
                  margin: 8px 0;
                  font-weight: bold;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
              }
              .portion-count {
                  color: #e67e22;
                  font-size: 14px;
                  font-weight: normal;
              }
              .category-section {
                  margin-bottom: 25px;
              }
              .ingredients-list {
                  display: grid;
                  grid-template-columns: 1fr auto;
                  gap: 10px 20px;
                  max-width: 600px;
                  margin-bottom: 20px;
              }
              .ingredient {
                  border-bottom: 1px dotted #ccc;
                  padding: 5px 0;
              }
              .amount {
                  font-weight: bold;
                  color: #e67e22;
                  text-align: right;
                  border-bottom: 1px dotted #ccc;
                  padding: 5px 0;
              }
              @media print {
                  body { margin: 10px; }
              }
          </style>
      </head>
      <body>
          <h1>üõí Shopping List - Calendar Week ${calendarWeek}</h1>
          <p><strong>Calendar Week ${calendarWeek}</strong> | Generated on ${new Date().toLocaleDateString()}</p>

          <div class="meal-list">
              <h2>üìã This Week's Meals:</h2>
              ${weekMeals.map(meal => `
                  <div class="meal-item">
                      <span>‚Ä¢ ${meal.title}</span>
                      <span class="portion-count">(4 portions)</span>
                  </div>
              `).join('')}
          </div>

          <h2>ü•ò Shopping List by Category:</h2>
          ${Object.entries(categorizedIngredients)
              .filter(([category, ingredients]) => Object.keys(ingredients).length > 0)
              .map(([category, ingredients]) => `
                  <div class="category-section">
                      <h3>${category}</h3>
                      <div class="ingredients-list">
                          ${Object.entries(ingredients)
                              .sort(([a], [b]) => a.localeCompare(b))
                              .map(([ingredient, amount]) => `
                                  <div class="ingredient">${ingredient}</div>
                                  <div class="amount">${amount}</div>
                              `).join('')}
                      </div>
                  </div>
              `).join('')}

          <p style="margin-top: 40px; font-size: 12px; color: #7f8c8d;">
              Generated by Weekly Meal Planner | All ingredients calculated for 4 portions per meal
          </p>
      </body>
      </html>`;

                  // Create and download PDF
                  const blob = new Blob([pdfContent], { type: 'text/html' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `shopping-list-calendar-week-${calendarWeek}.html`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);

                  // Show success message
                  alert('Shopping list exported! The file will open in your browser where you can print it as PDF.');
              }

              function nextWeek() {
                  currentWeek++;

                  if (!allWeeklyMeals[currentWeek]) {
                      // Reset used meals every 4 weeks to ensure variety
                      if (currentWeek % 4 === 0) {
                          usedMeatMeals = [];
                          usedVegetarianMeals = [];
                      }
                      const selectedMeals = generateWeeklyMeals();
                      allWeeklyMeals[currentWeek] = selectedMeals;
                  }

                  displayMeals(allWeeklyMeals[currentWeek]);

                  document.getElementById('prevWeekBtn').style.display = 'inline-block';
                  document.getElementById('nextWeekBtn').style.display = 'inline-block';
                  updateWeekDisplay();
              }

              function previousWeek() {
                  if (currentWeek > 0) {
                      currentWeek--;
                      displayMeals(allWeeklyMeals[currentWeek]);

                      document.getElementById('prevWeekBtn').style.display = currentWeek > 0 ? 'inline-block' : 'none';
                      document.getElementById('nextWeekBtn').style.display = 'inline-block';
                      updateWeekDisplay();
                  }
              }

              function showFavorites() {
                  if (favorites.length === 0) {
                      alert('No favorite meals yet! Rate some meals with üëç to add them to favorites.');
                      return;
                  }

                  showListView('favorites');
              }

              function showBanned() {
                  if (banned.length === 0) {
                      alert('No banned meals yet! Rate some meals with üëé to ban them.');
                      return;
                  }

                  showListView('banned');
              }

              function showListView(type) {
                  const isMainView = document.getElementById('mealsContainer').style.display !== 'none';
                  
                  if (isMainView) {
                      document.getElementById('mealsContainer').style.display = 'none';
                      document.querySelector('.button-container').style.display = 'none';
                      document.getElementById('weekIndicator').style.display = 'none';
                  }

                  document.getElementById('favoritesContainer').style.display = type === 'favorites' ? 'block' : 'none';
                  document.getElementById('bannedContainer').style.display = type === 'banned' ? 'block' : 'none';

                  const allMeals = [...meatMeals, ...vegetarianMeals];
                  const targetMeals = type === 'favorites' ? 
                      allMeals.filter(meal => favorites.includes(meal.title)) :
                      allMeals.filter(meal => banned.includes(meal.title));

                  const gridId = type === 'favorites' ? 'favoritesMealsGrid' : 'bannedMealsGrid';
                  const container = document.getElementById(gridId);

                  container.innerHTML = '';
                  targetMeals.forEach(meal => {
                      const mealCard = document.createElement('div');
                      mealCard.className = 'meal-card';

                      const rating = mealRatings[meal.title] || '';
                      const thumbUpActive = rating === 'up' ? 'active' : '';
                      const thumbDownActive = rating === 'down' ? 'active' : '';

                      mealCard.innerHTML = `
                          <img src="${meal.image}" alt="${meal.title}" class="meal-image">
                          <div class="meal-title">${meal.title}</div>
                          <div class="rating-buttons">
                              <button class="thumb-btn thumb-up ${thumbUpActive}" onclick="rateMeal('${meal.title}', 'up')">
                                  üëç
                              </button>
                              <button class="thumb-btn thumb-down ${thumbDownActive}" onclick="rateMeal('${meal.title}', 'down')">
                                  üëé
                              </button>
                          </div>
                      `;

                      container.appendChild(mealCard);
                  });
              }

              function showMainView() {
                  document.getElementById('mealsContainer').style.display = '';
                  document.querySelector('.button-container').style.display = '';
                  document.getElementById('weekIndicator').style.display = Object.keys(allWeeklyMeals).length > 0 ? 'block' : 'none';
                  document.getElementById('favoritesContainer').style.display = 'none';
                  document.getElementById('bannedContainer').style.display = 'none';
              }

              function saveState() {
                  const state = {
                      currentWeek,
                      allWeeklyMeals,
                      usedMeatMeals,
                      usedVegetarianMeals,
                      favorites,
                      banned,
                      mealRatings,
                      startingCalendarWeek,
                      saveDate: new Date().toISOString()
                  };
                  
                  const stateString = JSON.stringify(state, null, 2);
                  const blob = new Blob([stateString], { type: 'application/json' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `meal-planner-state-${new Date().toISOString().split('T')[0]}.json`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                  
                  alert('State saved successfully! You can now load this state anytime.');
              }

              function loadState() {
                  const input = document.createElement('input');
                  input.type = 'file';
                  input.accept = '.json';
                  input.style.display = 'none';
                  
                  input.onchange = function(event) {
                      const file = event.target.files[0];
                      if (!file) return;
                      
                      const reader = new FileReader();
                      reader.onload = function(e) {
                          try {
                              const state = JSON.parse(e.target.result);
                              
                              // Validate the state object
                              if (!state.allWeeklyMeals || typeof state.currentWeek !== 'number') {
                                  throw new Error('Invalid state file');
                              }
                              
                              // Restore state
                              currentWeek = state.currentWeek || 0;
                              allWeeklyMeals = state.allWeeklyMeals || {};
                              usedMeatMeals = state.usedMeatMeals || [];
                              usedVegetarianMeals = state.usedVegetarianMeals || [];
                              favorites = state.favorites || [];
                              banned = state.banned || [];
                              mealRatings = state.mealRatings || {};
                              startingCalendarWeek = state.startingCalendarWeek || getCurrentWeekNumber();
                              
                              // Update display
                              if (allWeeklyMeals[currentWeek]) {
                                  displayMeals(allWeeklyMeals[currentWeek]);
                                  
                                  // Show navigation buttons
                                  document.getElementById('nextWeekBtn').style.display = 'inline-block';
                                  document.getElementById('prevWeekBtn').style.display = currentWeek > 0 ? 'inline-block' : 'none';
                                  document.getElementById('weekIndicator').style.display = 'block';
                                  document.getElementById('exportBtn').style.display = 'inline-block';
                                  document.getElementById('favoritesBtn').style.display = favorites.length > 0 ? 'inline-block' : 'none';
                                  document.getElementById('bannedBtn').style.display = banned.length > 0 ? 'inline-block' : 'none';
                                  document.getElementById('surpriseBtn').style.display = favorites.length >= 4 ? 'inline-block' : 'none';
                                  document.getElementById('saveBtn').style.display = 'inline-block';
                                  
                                  updateWeekDisplay();
                              }
                              
                              const saveDate = state.saveDate ? new Date(state.saveDate).toLocaleDateString() : 'Unknown date';
                              alert(`State loaded successfully! (Saved on ${saveDate})`);
                              
                          } catch (error) {
                              alert('Error loading state file. Please make sure it\'s a valid meal planner state file.');
                              console.error('Load state error:', error);
                          }
                      };
                      
                      reader.readAsText(file);
                  };
                  
                  document.body.appendChild(input);
                  input.click();
                  document.body.removeChild(input);
              }
    </script>
  </body>
</html>
