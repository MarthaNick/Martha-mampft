<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Martha's Meals</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background-color: #ffffff;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        color: #2c3e50;
        margin-bottom: 30px;
        text-align: center;
        font-size: 2.2em;
      }

      .button-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 40px;
        align-items: center;
      }

      /* Top controls layout: legend left, buttons next to it */
      .top-controls {
        display: flex;
        gap: 24px;
        align-items: flex-start;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto 20px;
        flex-wrap: wrap;
      }
      #topConstraintsLegend { flex: 1 1 260px; min-width: 260px; }
      #topConstraintsLegend .legend-card { padding: 12px; }
      .buttons-panel { flex: 2 1 560px; background: #9e9e9e; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

      .button-row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }

      /* New layout for prev / randomize / next */
      .nav-randomize-row {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 20px;
        width: 100%;
        max-width: 900px;
      }
      .align-left { justify-self: start; }
      .align-right { justify-self: end; }
      .randomize-btn {
        background: linear-gradient(45deg, #c8e6c9, #a5d6a7);
        box-shadow: 0 6px 20px rgba(165, 214, 167, 0.5);
        border: none;
        padding: 18px 40px;
        font-size: 22px;
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #2c3e50;
        font-weight: 600;
      }
      .randomize-btn:hover {
        transform: translateY(-2px);
        background: linear-gradient(45deg, #a5d6a7, #81c784);
        box-shadow: 0 8px 24px rgba(165, 214, 167, 0.65);
      }

      /* Base button styles */
      .generate-btn,
      .surprise-btn,
      .next-week-btn,
      .prev-week-btn,
      .export-btn,
      .favorites-btn,
      .banned-btn,
      .save-btn,
      .load-btn {
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #333;
        font-weight: 500;
      }

      /* Row 1: Green pastels (Generate, Next, Previous) */
      .generate-btn {
        background: linear-gradient(45deg, #c8e6c9, #a5d6a7);
        box-shadow: 0 4px 15px rgba(165, 214, 167, 0.4);
      }

      .generate-btn:hover {
        transform: translateY(-2px);
        background: linear-gradient(45deg, #a5d6a7, #81c784);
        box-shadow: 0 6px 20px rgba(165, 214, 167, 0.6);
      }

      .surprise-btn {
        background: linear-gradient(45deg, #dcedc8, #c5e1a5);
        box-shadow: 0 4px 15px rgba(197, 225, 165, 0.4);
      }

      .surprise-btn:hover {
        background: linear-gradient(45deg, #c5e1a5, #aed581);
        box-shadow: 0 6px 20px rgba(197, 225, 165, 0.6);
      }

      .next-week-btn,
      .prev-week-btn {
        background: linear-gradient(45deg, #b2dfdb, #80cbc4);
        box-shadow: 0 4px 15px rgba(128, 203, 196, 0.4);
      }

      .next-week-btn:hover,
      .prev-week-btn:hover {
        background: linear-gradient(45deg, #80cbc4, #4db6ac);
        box-shadow: 0 6px 20px rgba(128, 203, 196, 0.6);
      }

      /* Row 2: Blue pastels (Favorites, Banned) */
      .favorites-btn {
        background: linear-gradient(45deg, #e1f5fe, #b3e5fc);
        box-shadow: 0 4px 15px rgba(179, 229, 252, 0.4);
      }

      .favorites-btn:hover {
        background: linear-gradient(45deg, #b3e5fc, #81d4fa);
        box-shadow: 0 6px 20px rgba(179, 229, 252, 0.6);
      }

      .banned-btn {
        background: linear-gradient(45deg, #e8eaf6, #c5cae9);
        box-shadow: 0 4px 15px rgba(197, 202, 233, 0.4);
      }

      .banned-btn:hover {
        background: linear-gradient(45deg, #c5cae9, #9fa8da);
        box-shadow: 0 6px 20px rgba(197, 202, 233, 0.6);
      }

      /* Row 3: Yellow pastel (Export) */
      .export-btn {
        background: linear-gradient(45deg, #fff9c4, #fff59d);
        box-shadow: 0 4px 15px rgba(255, 245, 157, 0.4);
      }

      .export-btn:hover {
        background: linear-gradient(45deg, #fff59d, #fff176);
        box-shadow: 0 6px 20px rgba(255, 245, 157, 0.6);
      }

      /* Row 4: Red pastels (Save, Load) */
      .save-btn {
        background: linear-gradient(45deg, #ffebee, #ffcdd2);
        box-shadow: 0 4px 15px rgba(255, 205, 210, 0.4);
      }

      .save-btn:hover {
        background: linear-gradient(45deg, #ffcdd2, #ef9a9a);
        box-shadow: 0 6px 20px rgba(255, 205, 210, 0.6);
      }

      .load-btn {
        background: linear-gradient(45deg, #fce4ec, #f8bbd9);
        box-shadow: 0 4px 15px rgba(248, 187, 217, 0.4);
      }

      .load-btn:hover {
        background: linear-gradient(45deg, #f8bbd9, #f48fb1);
        box-shadow: 0 6px 20px rgba(248, 187, 217, 0.6);
      }

      .week-indicator {
        margin-bottom: 30px;
        padding: 15px 25px;
        background: #ecf0f1;
        border-radius: 15px;
        color: #2c3e50;
        font-weight: bold;
        font-size: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
      }

      .calendar-week {
        font-size: 14px;
        color: #7f8c8d;
        font-weight: normal;
      }

      .meals-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 25px;
        max-width: 1400px;
        width: 100%;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
      }
      
      @media (max-width: 1200px) {
        .meals-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      @media (max-width: 768px) {
        .meals-container {
          grid-template-columns: 1fr;
        }
      }

      .meals-container.show {
        opacity: 1;
        transform: translateY(0);
      }

      .meal-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .meal-card:hover {
        transform: translateY(-5px);
      }

      .meal-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background-color: #f0f0f0;
      }

      .meal-title {
        padding: 20px;
        font-size: 16px;
        color: #2c3e50;
        line-height: 1.4;
        text-align: center;
        font-weight: 500;
      }

      .rating-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        padding: 0 20px 20px;
      }

      .thumb-btn {
        background: none;
        border: 2px solid #ecf0f1;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .thumb-btn:hover {
        transform: scale(1.1);
      }

      .thumb-up {
        color: #27ae60;
      }

      .thumb-up:hover,
      .thumb-up.active {
        background: #27ae60;
        color: white;
        border-color: #27ae60;
      }

      .thumb-down {
        color: #e74c3c;
      }

      .thumb-down:hover,
      .thumb-down.active {
        background: #e74c3c;
        color: white;
        border-color: #e74c3c;
      }

      .list-container {
        display: none;
        max-width: 1200px;
        width: 100%;
        margin-top: 20px;
      }

      .list-container.show {
        display: block;
      }

      .list-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .list-header h2 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .shopping-list-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 15px;
      }

      .back-btn {
        background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .back-btn:hover {
        background: linear-gradient(45deg, #7f8c8d, #6c7b7d);
        transform: translateY(-2px);
      }

      .download-btn {
        background: linear-gradient(45deg, #fff9c4, #fff59d);
        color: #333;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .download-btn:hover {
        background: linear-gradient(45deg, #fff59d, #fff176);
        transform: translateY(-2px);
      }

      #shoppingListContent {
        max-width: 800px;
        margin: 0 auto;
        text-align: left;
      }

      .shopping-week-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      .shopping-meals-list {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
      }

      .shopping-meals-list h3 {
        color: #27ae60;
        margin-bottom: 15px;
      }

      .shopping-meal-item {
        margin: 8px 0;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .portion-count {
        color: #e67e22;
        font-size: 14px;
        font-weight: normal;
      }

      .shopping-category-section {
        margin-bottom: 25px;
      }

      .shopping-category-title {
        color: #3498db;
        margin-bottom: 10px;
        border-left: 4px solid #3498db;
        padding-left: 10px;
        font-size: 1.2em;
        font-weight: bold;
      }

      .shopping-ingredients-list {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px 20px;
        max-width: 100%;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }

      .shopping-ingredient {
        border-bottom: 1px dotted #ccc;
        padding: 8px 0;
      }

      .shopping-amount {
        font-weight: bold;
        color: #e67e22;
        text-align: right;
        border-bottom: 1px dotted #ccc;
        padding: 8px 0;
      }
      /* Added: split layout and per-meal table */
      .shopping-category-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        align-items: start;
      }
      @media (max-width: 900px) {
        .shopping-category-content { grid-template-columns: 1fr; }
      }
      .per-meal-table-wrapper {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        overflow: auto;
      }
      .per-meal-table { width: 100%; border-collapse: collapse; font-size: 14px; }
      .per-meal-table th, .per-meal-table td {
        border-bottom: 1px dotted #ccc;
        padding: 8px 6px;
        text-align: center;
        vertical-align: top;
        white-space: nowrap;
      }
      .per-meal-table th { color: #2c3e50; font-weight: 600; background: #f8f9fa; }
      .shopping-meal-actions { display: flex; gap: 8px; align-items: center; }
      .meal-toggle-btn {
        background: linear-gradient(45deg, #e8eaf6, #c5cae9);
        color: #333;
        border: none;
        padding: 6px 10px;
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
      }
      .meal-toggle-btn:hover { background: linear-gradient(45deg, #c5cae9, #9fa8da); }
      .meal-toggle-btn.deactivated { background: linear-gradient(45deg, #fbe9e7, #ffccbc); }

      /* Constraint badges */
      .constraints-row { display: flex; flex-wrap: wrap; gap: 6px; padding: 0 16px 16px; justify-content: center; }
      .constraint-badge { font-size: 11px; padding: 4px 8px; border-radius: 12px; color: #2c3e50; background: #ecf0f1; border: 1px solid rgba(0,0,0,0.05); }
      .badge-pasta { background: #ffe0b2; }
      .badge-green_vegetable { background: #c8e6c9; }
      .badge-oven { background: #ffccbc; }
      .badge-grain { background: #bbdefb; }
      .badge-seasonal { background: #e1bee7; }
      .badge-salad { background: #dcedc8; }
      .badge-beans_lentils { background: #f8bbd0; }
      .badge-eggs { background: #fff59d; }
      .badge-dairy { background: #e0f7fa; }

      /* Constraints legend */
      #constraintsLegend { max-width: 1200px; width: 100%; margin: 24px auto 0; display: none; }
      #constraintsLegend.show { display: block; }
      .legend-card { background: #ffffff; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
      .legend-title { color: #2c3e50; margin-bottom: 10px; text-align: center; }
      .legend-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }

      /* Unified shopping table with 4 meal columns */
      .shopping-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      .shopping-table th, .shopping-table td { border-bottom: 1px dotted #ccc; padding: 8px 10px; text-align: left; }
      .shopping-table th { background: #f8f9fa; color: #2c3e50; font-weight: 600; }
      .shopping-table .amount-cell { text-align: right; color: #e67e22; font-weight: bold; }
      .shopping-table .center { text-align: center; }
      /* Meal column colors */
      .meal-col-1 { background: #fff3e0; }
      .meal-col-2 { background: #e8f5e9; }
      .meal-col-3 { background: #e3f2fd; }
      .meal-col-4 { background: #f3e5f5; }
      .meal-header-1 { background: #ffe0b2 !important; }
      .meal-header-2 { background: #c8e6c9 !important; }
      .meal-header-3 { background: #bbdefb !important; }
      .meal-header-4 { background: #e1bee7 !important; }
      .meal-badge { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 50%; font-size: 12px; font-weight: 700; color: #2c3e50; margin-right: 8px; }
      .meal-badge-1 { background: #ffe0b2; }
      .meal-badge-2 { background: #c8e6c9; }
      .meal-badge-3 { background: #bbdefb; }
      .meal-badge-4 { background: #e1bee7; }
    </style>
  </head>
  <body>
    <h1>Martha's Meals</h1>

    <div class="top-controls">
      <div id="topConstraintsLegend">
        <div class="legend-card">
          <div class="legend-title" style="text-align:left;">Constraints reminder</div>
          <div class="legend-list" style="justify-content:flex-start;">
            <span class="constraint-badge badge-pasta">pasta</span>
            <span class="constraint-badge badge-green_vegetable">green_vegetable</span>
            <span class="constraint-badge badge-oven">oven</span>
            <span class="constraint-badge badge-grain">grain</span>
            <span class="constraint-badge badge-seasonal">seasonal</span>
            <span class="constraint-badge badge-salad">salad</span>
            <span class="constraint-badge badge-beans_lentils">beans_lentils</span>
            <span class="constraint-badge badge-eggs">eggs</span>
            <span class="constraint-badge badge-dairy">dairy</span>
            <span class="constraint-badge">3× vegetarian</span>
            <span class="constraint-badge">1× meat/poultry/fish</span>
          </div>
        </div>
        <div class="legend-card" style="margin-top:12px;">
          <div class="legend-title" style="text-align:left;">World food regions</div>
          <div class="legend-list" style="justify-content:flex-start;">
            <span class="constraint-badge">mediterranean</span>
            <span class="constraint-badge">eastern_european</span>
            <span class="constraint-badge">scandinavian</span>
            <span class="constraint-badge">germanic</span>
            <span class="constraint-badge">north_american</span>
            <span class="constraint-badge">middle_eastern</span>
            <span class="constraint-badge">latin_american</span>
            <span class="constraint-badge">south_east_asian</span>
            <span class="constraint-badge">east_asian</span>
            <span class="constraint-badge">african</span>
            <span class="constraint-badge">caribbean</span>
          </div>
        </div>
      </div>
      <div class="buttons-panel">
      <div class="button-container">
      <!-- Row 1: Prev | New Randomization | Next -->
      <div class="nav-randomize-row">
        <button class="prev-week-btn align-left" onclick="previousWeek()" id="prevWeekBtn">← Previous Week</button>
        <button class="randomize-btn" onclick="newRandomization()" id="randomizeBtn">New Randomization</button>
        <button class="next-week-btn align-right" onclick="nextWeek()" id="nextWeekBtn">Next Week →</button>
      </div>

      <!-- Row 2: Favorites, Banned (Blue pastels) -->
      <div class="button-row">
        <button
          class="favorites-btn"
          onclick="showFavorites()"
          id="favoritesBtn"
          style="display: none"
        >
          ❤️ Favorites
        </button>
        <button
          class="banned-btn"
          onclick="showBanned()"
          id="bannedBtn"
          style="display: none"
        >
          🚫 Banned
        </button>
      </div>

      <!-- Row 3: Export Shopping List (Yellow pastel) -->
      <div class="button-row">
        <button
          class="export-btn"
          onclick="showShoppingList()"
          id="exportBtn"
          style="display: none"
        >
          📋 View Shopping List
        </button>
      </div>

      <!-- Row 4: Save, Load State (Red pastels) -->
      <div class="button-row">
        <button
          class="save-btn"
          onclick="saveState()"
          id="saveBtn"
        >
          💾 Save State
        </button>
        <button
          class="load-btn"
          onclick="loadState()"
          id="loadBtn"
        >
          📂 Load State
        </button>
      </div>
      </div>
    </div>

    <div class="week-indicator" id="weekIndicator" style="display: none">
      <span id="weekText"></span>
    </div>

    <div class="meals-container" id="mealsContainer"></div>
    <div id="constraintsLegend">
      <div class="legend-card">
        <div class="legend-title">Weekly constraints to satisfy</div>
        <div class="legend-list">
          <span class="constraint-badge badge-pasta">pasta</span>
          <span class="constraint-badge badge-green_vegetable">green_vegetable</span>
          <span class="constraint-badge badge-oven">oven</span>
          <span class="constraint-badge badge-grain">grain</span>
          <span class="constraint-badge badge-seasonal">seasonal</span>
          <span class="constraint-badge badge-salad">salad</span>
          <span class="constraint-badge badge-beans_lentils">beans_lentils</span>
          <span class="constraint-badge badge-eggs">eggs</span>
          <span class="constraint-badge badge-dairy">dairy</span>
          <span class="constraint-badge">3× vegetarian</span>
          <span class="constraint-badge">1× meat/poultry/fish</span>
        </div>
      </div>
    </div>

    <script src="meals.js"></script>
    <div class="list-container" id="favoritesContainer">
      <div class="list-header">
        <h2>❤️ Favorite Meals</h2>
        <button class="back-btn" onclick="showMainView()">
          ← Back to Meal Planner
        </button>
      </div>
      <div class="meals-container show" id="favoritesMealsGrid"></div>
    </div>

    <div class="list-container" id="bannedContainer">
      <div class="list-header">
        <h2>🚫 Banned Meals</h2>
        <button class="back-btn" onclick="showMainView()">
          ← Back to Meal Planner
        </button>
      </div>
      <div class="meals-container show" id="bannedMealsGrid"></div>
    </div>

    <div class="list-container" id="shoppingListContainer">
      <div class="list-header">
        <h2>📋 Shopping List</h2>
        <div class="shopping-list-buttons">
          <button class="back-btn" onclick="showMainView()">
            ← Back to Meal Planner
          </button>
          <button class="download-btn" onclick="downloadShoppingList()">
            📥 Download List
          </button>
        </div>
      </div>
      <div id="shoppingListContent"></div>
    </div>

    <script>

              let currentWeek = 0;
              let weeklyMeals = [];
              let usedMeatMeals = [];
              let usedVegetarianMeals = [];
              let allWeeklyMeals = {}; // Store meals for all weeks
              let favorites = [];
              let banned = [];
              let mealRatings = {}; // Store ratings for each meal
              let startingCalendarWeek = getCurrentWeekNumber(); // Track when meal planning started
              let deactivatedMealsByWeek = {};

              function getFlagForTitle(title) {
                  const t = title.toLowerCase();
                  // Direct country keywords
                  if (t.includes('italian') || t.includes('osso buco') || t.includes('parmigiana') || t.includes('saltimbocca') || t.includes('moussaka')) return '🇮🇹';
                  if (t.includes('polish') || t.includes('pierogi') || t.includes('kapusta')) return '🇵🇱';
                  if (t.includes('swedish') || t.includes('janssons') || t.includes('meatballs')) return '🇸🇪';
                  if (t.includes('norwegian')) return '🇳🇴';
                  if (t.includes('german') || t.includes('sauerbraten')) return '🇩🇪';
                  if (t.includes('austrian') || t.includes('wiener schnitzel') || t.includes('kaiserschmarrn')) return '🇦🇹';
                  if (t.includes('swiss') || t.includes('rösti') || t.includes('roesti') || t.includes('gruyère')) return '🇨🇭';
                  if (t.includes('new england') || t.includes('bbq') || t.includes('american') || t.includes('canadian') || t.includes('tourtière')) return '🇺🇸';
                  if (t.includes('canadian')) return '🇨🇦';
                  if (t.includes('moroccan') || t.includes('tagine')) return '🇲🇦';
                  if (t.includes('brazilian') || t.includes('feijoada')) return '🇧🇷';
                  if (t.includes('indian') || t.includes('dal makhani') || t.includes('butter chicken')) return '🇮🇳';
                  if (t.includes('korean') || t.includes('bulgogi') || t.includes('bibimbap') || t.includes('kimchi')) return '🇰🇷';
                  if (t.includes('japanese') || t.includes('ramen') || t.includes('teriyaki')) return '🇯🇵';
                  if (t.includes('ethiopian') || t.includes('injera') || t.includes('doro wat')) return '🇪🇹';
                  if (t.includes('jamaican') || t.includes('jerk') || t.includes('callaloo')) return '🇯🇲';
                  if (t.includes('lebanese') || t.includes('fattoush')) return '🇱🇧';
                  if (t.includes('mexican') || t.includes('chiles rellenos')) return '🇲🇽';
                  if (t.includes('turkish') || t.includes('imam bayildi')) return '🇹🇷';
                  if (t.includes('greek') || t.includes('moussaka')) return '🇬🇷';
                  if (t.includes('ukrainian') || t.includes('borscht')) return '🇺🇦';
                  if (t.includes('danish') || t.includes('smørrebrød') || t.includes('smorrebrod')) return '🇩🇰';
                  if (t.includes('peruvian') || t.includes('quinoa soup')) return '🇵🇪';
                  if (t.includes('thai') || t.includes('papaya salad')) return '🇹🇭';
                  if (t.includes('cuban')) return '🇨🇺';
                  if (t.includes('norwegian')) return '🇳🇴';
                  if (t.includes('korean')) return '🇰🇷';
                  // Region fallbacks
                  return '🌍';
              }

              function getCurrentWeekNumber() {
                  const now = new Date();
                  const firstDayOfYear = new Date(now.getFullYear(), 0, 1);
                  const pastDaysOfYear = (now - firstDayOfYear) / 86400000;
                  return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
              }

              function getCalendarWeekForMealWeek(mealWeek) {
                  const currentCalendarWeek = getCurrentWeekNumber();
                  const targetWeek = currentCalendarWeek + mealWeek;

                  // Handle year overflow (weeks 53+ should wrap to next year)
                  if (targetWeek > 52) {
                      return targetWeek - 52;
                  }
                  return targetWeek;
              }

              function shuffleArray(array) {
                  const shuffled = [...array];
                  for (let i = shuffled.length - 1; i > 0; i--) {
                      const j = Math.floor(Math.random() * (i + 1));
                      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                  }
                  return shuffled;
              }

              function generateWeeklyMeals() {
                  // Helper: try once to build a valid week set meeting strict rules
                  function tryBuildWeek() {
                      // Exclude meals from the previous 3 weeks (no repeats within any 4 consecutive weeks)
                      const recentTitles = new Set();
                      for (let w = Math.max(0, currentWeek - 3); w <= currentWeek - 1; w++) {
                          if (allWeeklyMeals[w]) {
                              allWeeklyMeals[w].forEach(m => recentTitles.add(m.title));
                          }
                      }

                      const availableMeatMeals = meatMeals.filter(meal => !banned.includes(meal.title) && !recentTitles.has(meal.title));
                      const availableVegetarianMeals = vegetarianMeals.filter(meal => !banned.includes(meal.title) && !recentTitles.has(meal.title));

                      const requiredConstraints = [
                          'seasonal','salad','oven','pasta','beans_lentils','eggs','dairy','grain','green_vegetable'
                      ];

                      // pick 1 meat
                      if (availableMeatMeals.length === 0) return null;
                      const meat = shuffleArray(availableMeatMeals)[0];

                      // pick 3 vegetarian
                      if (availableVegetarianMeals.length < 3) return null;
                      let vegPool = shuffleArray(availableVegetarianMeals);

                      // Greedy cover constraints
                      const selected = [meat];
                      const covered = new Set(meat.constraints || []);
                      for (let i = 0; i < vegPool.length && selected.length < 4; i++) {
                          const candidate = vegPool[i];
                          // prefer that adds new constraints
                          const adds = (candidate.constraints || []).some(c => !covered.has(c));
                          if (adds || (4 - selected.length) >= (requiredConstraints.filter(c=>!covered.has(c)).length)) {
                              selected.push(candidate);
                              (candidate.constraints || []).forEach(c => covered.add(c));
                          }
                      }
                      if (selected.length < 4) return null;

                      // if still not 3 veg, adjust
                      const vegCount = selected.filter(m => m.type === 'vegetarian').length;
                      if (vegCount !== 3) return null;

                      // validate constraint coverage
                      const hasAll = requiredConstraints.every(c => selected.some(m => (m.constraints||[]).includes(c)));
                      if (!hasAll) return null;

                      return shuffleArray(selected);
                  }

                  // Retry loop to satisfy constraints
                  for (let attempts = 0; attempts < 400; attempts++) {
                      const built = tryBuildWeek();
                      if (built) {
                          return built;
                      }
                  }
                  // Fallback: relax recent constraint but still honor banned and type/coverage if possible
                  const poolMeat = meatMeals.filter(m=>!banned.includes(m.title));
                  const poolVeg = vegetarianMeals.filter(m=>!banned.includes(m.title));
                  if (poolMeat.length && poolVeg.length >= 3) {
                      const meat = shuffleArray(poolMeat)[0];
                      const vegs = shuffleArray(poolVeg).slice(0,3);
                      const selected = [meat, ...vegs];
                      return selected;
                  }
                  const allMeals = shuffleArray([...poolMeat, ...poolVeg]);
                  return allMeals.slice(0,4);
              }

              function displayMeals(meals) {
                  const container = document.getElementById('mealsContainer');

                  // Hide container first
                  container.classList.remove('show');

                  setTimeout(() => {
                      container.innerHTML = '';

                      meals.forEach((meal, index) => {
                          const mealCard = document.createElement('div');
                          mealCard.className = 'meal-card';

                          const rating = mealRatings[meal.title] || '';
                          const thumbUpActive = rating === 'up' ? 'active' : '';
                          const thumbDownActive = rating === 'down' ? 'active' : '';

                          mealCard.innerHTML = `
                              <img src="${meal.image}" alt="${meal.title}" class="meal-image">
                              <div class="meal-title">
                                  ${getFlagForTitle(meal.title)} ${meal.title}
                              </div>
                              <div class="constraints-row">
                                  ${(meal.constraints || []).map(c => `<span class=\"constraint-badge badge-${c}\">${c}</span>`).join('')}
                              </div>
                              <div class="rating-buttons">
                                  <button class="thumb-btn thumb-up ${thumbUpActive}" onclick="rateMeal('${meal.title}', 'up')">
                                      👍
                                  </button>
                                  <button class="thumb-btn thumb-down ${thumbDownActive}" onclick="rateMeal('${meal.title}', 'down')">
                                      👎
                                  </button>
                              </div>
                          `;

                          container.appendChild(mealCard);
                      });

                      // Show container with animation
                      setTimeout(() => {
                          container.classList.add('show');
                      }, 100);
                  }, 300);
              }

              function rateMeal(mealTitle, rating) {
                  // Update rating
                  mealRatings[mealTitle] = rating;

                  if (rating === 'up') {
                      // Add to favorites if not already there
                      if (!favorites.includes(mealTitle)) {
                          favorites.push(mealTitle);
                      }
                      // Remove from banned if it was there
                      banned = banned.filter(title => title !== mealTitle);
                  } else if (rating === 'down') {
                      // Add to banned if not already there
                      if (!banned.includes(mealTitle)) {
                          banned.push(mealTitle);
                      }
                      // Remove from favorites if it was there
                      favorites = favorites.filter(title => title !== mealTitle);
                  }

                  // Update button states
                  updateRatingButtons();

                  // Show favorites/banned buttons
                  document.getElementById('favoritesBtn').style.display = favorites.length > 0 ? 'inline-block' : 'none';
                  document.getElementById('bannedBtn').style.display = banned.length > 0 ? 'inline-block' : 'none';
              }

              function updateRatingButtons() {
                  const thumbButtons = document.querySelectorAll('.thumb-btn');
                  thumbButtons.forEach(button => {
                      const mealTitle = button.onclick.toString().match(/'([^']+)'/)[1];
                      const rating = mealRatings[mealTitle];

                      button.classList.remove('active');
                      if ((button.classList.contains('thumb-up') && rating === 'up') ||
                          (button.classList.contains('thumb-down') && rating === 'down')) {
                          button.classList.add('active');
                      }
                  });
              }

              function updateWeekDisplay() {
                  const calendarWeek = getCalendarWeekForMealWeek(currentWeek);
                  document.getElementById('weekText').textContent = `Calendar Week ${calendarWeek}`;
              }

              function newRandomization() {
                  // Generate 4 random meals for the current week honoring constraints
                  const selectedMeals = generateWeeklyMeals();
                  allWeeklyMeals[currentWeek] = selectedMeals;
                  displayMeals(selectedMeals);
                  // Reveal controls
                  document.getElementById('nextWeekBtn').style.display = 'inline-block';
                  document.getElementById('prevWeekBtn').style.display = currentWeek > 0 ? 'inline-block' : 'none';
                  document.getElementById('weekIndicator').style.display = 'block';
                  document.getElementById('exportBtn').style.display = 'inline-block';
                  document.getElementById('favoritesBtn').style.display = 'inline-block';
                  document.getElementById('bannedBtn').style.display = 'inline-block';
                  document.getElementById('surpriseBtn').style.display = 'inline-block';
                  document.getElementById('saveBtn').style.display = 'inline-block';
                  document.getElementById('randomizeBtn').style.display = 'inline-block';
                  document.getElementById('weekIndicator').style.display = 'block';
                  updateWeekDisplay();
              }

              function generateMeals() {
                  // Backward compatibility retained
                  if (Object.keys(allWeeklyMeals).length === 0) {
                      currentWeek = 0;
                      startingCalendarWeek = getCurrentWeekNumber();
                      usedMeatMeals = [];
                      usedVegetarianMeals = [];
                      allWeeklyMeals = {};
                  }
                  newRandomization();
              }

              // Auto-generate on first load
              document.addEventListener('DOMContentLoaded', () => {
                  currentWeek = 0;
                  startingCalendarWeek = getCurrentWeekNumber();
                  usedMeatMeals = [];
                  usedVegetarianMeals = [];
                  allWeeklyMeals = {};
                  newRandomization();
              });

              function surpriseMe() {
                  if (favorites.length < 4) {
                      alert('You need at least 4 favorite meals to use Surprise Me!');
                      return;
                  }

                  currentWeek = 0;
                  startingCalendarWeek = getCurrentWeekNumber();
                  allWeeklyMeals = {};

                  // Get all favorite meals
                  const allMeals = [...meatMeals, ...vegetarianMeals];
                  const favoriteMeals = allMeals.filter(meal => favorites.includes(meal.title));

                  // Try to maintain 1 meat + 3 vegetarian structure if possible
                  const favoriteMeatMeals = favoriteMeals.filter(meal => meal.type === 'meat');
                  const favoriteVegetarianMeals = favoriteMeals.filter(meal => meal.type === 'vegetarian');

                  let selectedMeals = [];

                  if (favoriteMeatMeals.length >= 1 && favoriteVegetarianMeals.length >= 3) {
                      // Perfect balance possible
                      selectedMeals.push(shuffleArray(favoriteMeatMeals)[0]);
                      selectedMeals.push(...shuffleArray(favoriteVegetarianMeals).slice(0, 3));
                  } else {
                      // Just pick any 4 favorites
                      selectedMeals = shuffleArray(favoriteMeals).slice(0, 4);
                  }

                  allWeeklyMeals[0] = selectedMeals;
                  displayMeals(selectedMeals);

                  // Show navigation buttons
                  document.getElementById('nextWeekBtn').style.display = 'inline-block';
                  document.getElementById('prevWeekBtn').style.display = currentWeek > 0 ? 'inline-block' : 'none';
                  document.getElementById('randomizeBtn').style.display = 'inline-block';
                  document.getElementById('weekIndicator').style.display = 'block';
                  document.getElementById('exportBtn').style.display = 'inline-block';
                  document.getElementById('saveBtn').style.display = 'inline-block';
                  updateWeekDisplay();
              }

              function showShoppingList() {
                  if (!allWeeklyMeals[currentWeek]) {
                      alert('No meals generated for this week!');
                      return;
                  }

                  const isMainView = document.getElementById('mealsContainer').style.display !== 'none';
                  
                  if (isMainView) {
                      document.getElementById('mealsContainer').style.display = 'none';
                      document.querySelector('.button-container').style.display = 'none';
                      document.getElementById('weekIndicator').style.display = 'none';
                  }

                  document.getElementById('favoritesContainer').style.display = 'none';
                  document.getElementById('bannedContainer').style.display = 'none';
                  document.getElementById('shoppingListContainer').style.display = 'block';

                  generateShoppingListContent();
              }

              function generateShoppingListContent() {
                  const weekMeals = allWeeklyMeals[currentWeek];
                  const calendarWeek = getCalendarWeekForMealWeek(currentWeek);
                  if (!deactivatedMealsByWeek[currentWeek]) { deactivatedMealsByWeek[currentWeek] = []; }
                  const deactivatedSet = new Set(deactivatedMealsByWeek[currentWeek]);

                  // Define ingredient categories in typical supermarket order
                  const categories = {
                      'Fresh Vegetables & Herbs': ['asparagus', 'spinach', 'arugula', 'rucola', 'kale', 'brussels sprouts', 'cabbage', 'peas', 'broccoli', 'zucchini', 'bell peppers', 'eggplants', 'cucumber', 'tomatoes', 'cherry tomatoes', 'onions', 'red onion', 'garlic', 'ginger', 'carrots', 'pumpkin', 'winter squash', 'seasonal vegetables', 'spring vegetables', 'seasonal root vegetables', 'mixed seasonal greens', 'mixed greens', 'basil', 'parsley', 'chives', 'thyme', 'rosemary', 'sage', 'oregano', 'dill', 'mint', 'herbs', 'seasonal herbs', 'fresh herbs', 'bok choy', 'scallions', 'cilantro', 'collard greens', 'callaloo leaves', 'wakame seaweed', 'nori seaweed', 'radishes', 'celery', 'bean sprouts', 'green papaya'],
                      'Fruits': ['lemons', 'apples', 'rhubarb', 'plums', 'lime', 'mixed berries', 'avocados', 'korean pear', 'dried apricots', 'dried cranberries', 'dried fruits'],
                      'Meat & Fish': ['salmon fillets', 'chicken breast', 'cod fillets', 'turkey breast', 'duck breast', 'pork tenderloin', 'veal shanks', 'kielbasa sausage', 'ground beef', 'ground pork', 'veal cutlets', 'beef brisket', 'lamb shoulder', 'beef short ribs', 'chorizo', 'chicken thighs', 'beef ribeye', 'chicken pieces', 'prosciutto', 'fresh clams', 'sea bass fillets', 'beef stew meat', 'pork chops', 'halibut fillets', 'trout fillets', 'swordfish steaks', 'rack of lamb', 'sole fillets', 'pork shoulder', 'beef roast', 'lamb shanks', 'lamb chops'],
                      'Dairy & Eggs': ['eggs', 'butter', 'milk', 'heavy cream', 'mascarpone cheese', 'ricotta cheese', 'mozzarella cheese', 'parmesan cheese', 'gruyere cheese', 'goat cheese', 'feta cheese', 'cheddar cheese', 'sour cream', 'cream cheese', 'monterey jack cheese', 'soft-boiled eggs', 'hard-boiled eggs'],
                      'Grains & Bread': ['wild rice', 'quinoa', 'pearl barley', 'brown rice', 'bulgur', 'basmati rice', 'arborio rice', 'pasta', 'lasagna sheets', 'bread', 'pie crust', 'puff pastry', 'breadcrumbs', 'flour', 'short grain rice', 'white rice', 'jasmine rice', 'couscous', 'rye bread', 'sourdough bread', 'naan bread', 'pita bread', 'injera bread', 'macaroni', 'spaetzle', 'ramen noodles', 'orzo pasta', 'egg noodles', 'corn tortillas', 'pierogi'],
                      'Legumes & Nuts': ['chickpeas', 'green lentils', 'red lentils', 'white beans', 'black beans', 'pine nuts', 'pumpkin seeds', 'kidney beans', 'black lentils', 'mixed lentils', 'walnuts', 'peanuts', 'sliced almonds'],
                      'Pantry & Condiments': ['olive oil', 'vegetable oil', 'salt', 'black pepper', 'nutmeg', 'curry powder', 'dijon mustard', 'balsamic vinegar', 'red wine vinegar', 'honey', 'sugar', 'tomato sauce', 'tomatoes (canned)', 'coconut cream', 'white wine', 'vegetable broth', 'coconut milk', 'soy sauce', 'sesame oil', 'teriyaki sauce', 'miso paste', 'garam masala', 'jerk seasoning', 'berbere spice', 'moroccan spice blend', 'enchilada sauce', 'bbq sauce', 'maple syrup', 'sumac', 'tomato salsa', 'fish sauce', 'gochujang', 'sesame seeds', 'lingonberry jam', 'red wine', 'beef broth', 'chicken broth', 'kimchi', 'sauerkraut', 'capers', 'kalamata olives', 'preserved lemons', 'tomato paste', 'gingersnap cookies', 'bay leaves', 'juniper berries', 'caraway seeds', 'cumin', 'turmeric', 'paprika', 'allspice', 'vanilla extract', 'baking powder', 'powdered sugar', 'brown sugar', 'palm sugar', 'scotch bonnet pepper', 'thai chilies', 'pickled beets']
                  };

                  // Aggregate all ingredients for active meals and track per-meal amounts
                  const ingredientsList = {};
                  const categorizedIngredients = {};
                  const perMealAmounts = {};

                  // Initialize categories
                  Object.keys(categories).forEach(category => {
                      categorizedIngredients[category] = {};
                  });
                  categorizedIngredients['Other'] = {};

                  weekMeals.forEach(meal => {
                      if (meal.ingredients) {
                          Object.entries(meal.ingredients).forEach(([ingredient, amount]) => {
                              if (!perMealAmounts[ingredient]) perMealAmounts[ingredient] = {};
                              perMealAmounts[ingredient][meal.title] = deactivatedSet.has(meal.title) ? '' : amount;
                              if (!deactivatedSet.has(meal.title)) {
                                  if (ingredientsList[ingredient]) {
                                      if (!ingredientsList[ingredient].includes(amount)) {
                                          ingredientsList[ingredient] += ` + ${amount}`;
                                      }
                                  } else {
                                      ingredientsList[ingredient] = amount;
                                  }
                              }
                          });
                      }
                  });

                  // Categorize ingredients
                  Object.entries(ingredientsList).forEach(([ingredient, amount]) => {
                      let found = false;
                      const lowerIngredient = ingredient.toLowerCase();
                      
                      for (const [category, keywords] of Object.entries(categories)) {
                          if (keywords.some(keyword => lowerIngredient.includes(keyword.toLowerCase()) || keyword.toLowerCase().includes(lowerIngredient))) {
                              categorizedIngredients[category][ingredient] = amount;
                              found = true;
                              break;
                          }
                      }
                      
                      if (!found) {
                          categorizedIngredients['Other'][ingredient] = amount;
                      }
                  });

                  // Generate HTML content
                  let htmlContent = `
                      <div class="shopping-week-info">
                          <h2>Shopping List - Calendar Week ${calendarWeek}</h2>
                          <p><strong>Generated on ${new Date().toLocaleDateString()}</strong></p>
                      </div>

                      <div class="shopping-meals-list">
                          <h3>📋 This Week's Meals:</h3>
                          ${weekMeals.map((meal, idx) => `
                              <div class=\"shopping-meal-item\"> 
                                  <span><span class=\"meal-badge meal-badge-${idx+1}\">${idx+1}</span>${getFlagForTitle(meal.title)} ${meal.title}</span>
                                  <span class=\"shopping-meal-actions\"> 
                                      <span class=\"portion-count\">(4 portions)</span>
                                      <button class=\"meal-toggle-btn ${deactivatedSet.has(meal.title) ? 'deactivated' : ''}\" onclick=\"toggleMealActive('${meal.title}')\">${deactivatedSet.has(meal.title) ? 'Activate' : 'Deactivate'}</button>
                                  </span> 
                              </div>
                          `).join('')}
                      </div>

                      <h2 style="color: #27ae60; margin-bottom: 20px;">🥘 Shopping List by Category:</h2>
                      ${Object.entries(categorizedIngredients)
                          .filter(([category, ingredients]) => Object.keys(ingredients).length > 0)
                          .map(([category, ingredients]) => `
                              <div class="shopping-category-section">
                                  <div class="shopping-category-title">${category}</div>
                                  <table class=\"shopping-table\"> 
                                      <thead>
                                          <tr>
                                              <th>Ingredient</th>
                                              <th class=\"amount-cell\">Total</th>
                                              ${weekMeals.map((m, idx) => `<th class=\"center meal-header-${idx+1}\">${idx+1}</th>`).join('')}
                                          </tr>
                                      </thead>
                                      <tbody>
                                          ${Object.entries(ingredients)
                                              .sort(([a], [b]) => a.localeCompare(b))
                                              .map(([ingredient, amount]) => `
                                                  <tr>
                                                      <td>${ingredient}</td>
                                                      <td class=\"amount-cell\">${amount}</td>
                                                      ${weekMeals.map((m, idx) => `<td class=\"center meal-col-${idx+1}\">${(perMealAmounts[ingredient] && perMealAmounts[ingredient][m.title]) ? perMealAmounts[ingredient][m.title] : ''}</td>`).join('')}
                                                  </tr>
                                              `).join('')}
                                      </tbody>
                                  </table>
                              </div>
                          `).join('')}
                  `;

                  document.getElementById('shoppingListContent').innerHTML = htmlContent;
              }

              function toggleMealActive(mealTitle) {
                  if (!deactivatedMealsByWeek[currentWeek]) { deactivatedMealsByWeek[currentWeek] = []; }
                  const list = deactivatedMealsByWeek[currentWeek];
                  const idx = list.indexOf(mealTitle);
                  if (idx >= 0) { list.splice(idx, 1); } else { list.push(mealTitle); }
                  generateShoppingListContent();
              }

              function downloadShoppingList() {
                  const weekMeals = allWeeklyMeals[currentWeek];
                  const calendarWeek = getCalendarWeekForMealWeek(currentWeek);
                  const deactivatedSet = new Set(deactivatedMealsByWeek[currentWeek] || []);

                  // Define ingredient categories in typical supermarket order
                  const categories = {
                      'Fresh Vegetables & Herbs': ['asparagus', 'spinach', 'arugula', 'rucola', 'kale', 'brussels sprouts', 'cabbage', 'peas', 'broccoli', 'zucchini', 'bell peppers', 'eggplants', 'cucumber', 'tomatoes', 'cherry tomatoes', 'onions', 'red onion', 'garlic', 'ginger', 'carrots', 'pumpkin', 'winter squash', 'seasonal vegetables', 'spring vegetables', 'seasonal root vegetables', 'mixed seasonal greens', 'mixed greens', 'basil', 'parsley', 'chives', 'thyme', 'rosemary', 'sage', 'oregano', 'dill', 'mint', 'herbs', 'seasonal herbs', 'fresh herbs', 'bok choy', 'scallions', 'cilantro', 'collard greens', 'callaloo leaves', 'wakame seaweed', 'nori seaweed', 'radishes', 'celery', 'bean sprouts', 'green papaya'],
                      'Fruits': ['lemons', 'apples', 'rhubarb', 'plums', 'lime', 'mixed berries', 'avocados', 'korean pear', 'dried apricots', 'dried cranberries', 'dried fruits'],
                      'Meat & Fish': ['salmon fillets', 'chicken breast', 'cod fillets', 'turkey breast', 'duck breast', 'pork tenderloin', 'veal shanks', 'kielbasa sausage', 'ground beef', 'ground pork', 'veal cutlets', 'beef brisket', 'lamb shoulder', 'beef short ribs', 'chorizo', 'chicken thighs', 'beef ribeye', 'chicken pieces', 'prosciutto', 'fresh clams', 'sea bass fillets', 'beef stew meat', 'pork chops', 'halibut fillets', 'trout fillets', 'swordfish steaks', 'rack of lamb', 'sole fillets', 'pork shoulder', 'beef roast', 'lamb shanks', 'lamb chops'],
                      'Dairy & Eggs': ['eggs', 'butter', 'milk', 'heavy cream', 'mascarpone cheese', 'ricotta cheese', 'mozzarella cheese', 'parmesan cheese', 'gruyere cheese', 'goat cheese', 'feta cheese', 'cheddar cheese', 'sour cream', 'cream cheese', 'monterey jack cheese', 'soft-boiled eggs', 'hard-boiled eggs'],
                      'Grains & Bread': ['wild rice', 'quinoa', 'pearl barley', 'brown rice', 'bulgur', 'basmati rice', 'arborio rice', 'pasta', 'lasagna sheets', 'bread', 'pie crust', 'puff pastry', 'breadcrumbs', 'flour', 'short grain rice', 'white rice', 'jasmine rice', 'couscous', 'rye bread', 'sourdough bread', 'naan bread', 'pita bread', 'injera bread', 'macaroni', 'spaetzle', 'ramen noodles', 'orzo pasta', 'egg noodles', 'corn tortillas', 'pierogi'],
                      'Legumes & Nuts': ['chickpeas', 'green lentils', 'red lentils', 'white beans', 'black beans', 'pine nuts', 'pumpkin seeds', 'kidney beans', 'black lentils', 'mixed lentils', 'walnuts', 'peanuts', 'sliced almonds'],
                      'Pantry & Condiments': ['olive oil', 'vegetable oil', 'salt', 'black pepper', 'nutmeg', 'curry powder', 'dijon mustard', 'balsamic vinegar', 'red wine vinegar', 'honey', 'sugar', 'tomato sauce', 'tomatoes (canned)', 'coconut cream', 'white wine', 'vegetable broth', 'coconut milk', 'soy sauce', 'sesame oil', 'teriyaki sauce', 'miso paste', 'garam masala', 'jerk seasoning', 'berbere spice', 'moroccan spice blend', 'enchilada sauce', 'bbq sauce', 'maple syrup', 'sumac', 'tomato salsa', 'fish sauce', 'gochujang', 'sesame seeds', 'lingonberry jam', 'red wine', 'beef broth', 'chicken broth', 'kimchi', 'sauerkraut', 'capers', 'kalamata olives', 'preserved lemons', 'tomato paste', 'gingersnap cookies', 'bay leaves', 'juniper berries', 'caraway seeds', 'cumin', 'turmeric', 'paprika', 'allspice', 'vanilla extract', 'baking powder', 'powdered sugar', 'brown sugar', 'palm sugar', 'scotch bonnet pepper', 'thai chilies', 'pickled beets']
                  };

                  // Aggregate all ingredients from active meals only
                  const ingredientsList = {};
                  const categorizedIngredients = {};

                  // Initialize categories
                  Object.keys(categories).forEach(category => {
                      categorizedIngredients[category] = {};
                  });
                  categorizedIngredients['Other'] = {};

                  weekMeals.forEach(meal => {
                      if (deactivatedSet.has(meal.title)) return;
                      if (meal.ingredients) {
                          Object.entries(meal.ingredients).forEach(([ingredient, amount]) => {
                              if (ingredientsList[ingredient]) {
                                  // If ingredient already exists, note multiple amounts
                                  if (!ingredientsList[ingredient].includes(amount)) {
                                      ingredientsList[ingredient] += ` + ${amount}`;
                                  }
                              } else {
                                  ingredientsList[ingredient] = amount;
                              }
                          });
                      }
                  });

                  // Categorize ingredients
                  Object.entries(ingredientsList).forEach(([ingredient, amount]) => {
                      let found = false;
                      const lowerIngredient = ingredient.toLowerCase();
                      
                      for (const [category, keywords] of Object.entries(categories)) {
                          if (keywords.some(keyword => lowerIngredient.includes(keyword.toLowerCase()) || keyword.toLowerCase().includes(lowerIngredient))) {
                              categorizedIngredients[category][ingredient] = amount;
                              found = true;
                              break;
                          }
                      }
                      
                      if (!found) {
                          categorizedIngredients['Other'][ingredient] = amount;
                      }
                  });

                  // Create PDF content
                  let pdfContent = `
      <!DOCTYPE html>
      <html>
      <head>
          <meta charset="UTF-8">
          <style>
              body {
                  font-family: Arial, sans-serif;
                  margin: 20px;
                  line-height: 1.4;
              }
              h1 {
                  color: #2c3e50;
                  border-bottom: 3px solid #3498db;
                  padding-bottom: 10px;
              }
              h2 {
                  color: #27ae60;
                  margin-top: 30px;
                  margin-bottom: 15px;
              }
              h3 {
                  color: #3498db;
                  margin-top: 25px;
                  margin-bottom: 10px;
                  border-left: 4px solid #3498db;
                  padding-left: 10px;
              }
              .meal-list {
                  background: #f8f9fa;
                  padding: 15px;
                  border-radius: 8px;
                  margin: 20px 0;
              }
              .meal-item {
                  margin: 8px 0;
                  font-weight: bold;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
              }
              .portion-count {
                  color: #e67e22;
                  font-size: 14px;
                  font-weight: normal;
              }
              .category-section {
                  margin-bottom: 25px;
              }
              .ingredients-list {
                  display: grid;
                  grid-template-columns: 1fr auto;
                  gap: 10px 20px;
                  max-width: 600px;
                  margin-bottom: 20px;
              }
              .ingredient {
                  border-bottom: 1px dotted #ccc;
                  padding: 5px 0;
              }
              .amount {
                  font-weight: bold;
                  color: #e67e22;
                  text-align: right;
                  border-bottom: 1px dotted #ccc;
                  padding: 5px 0;
              }
              @media print {
                  body { margin: 10px; }
              }
          </style>
      </head>
      <body>
          <h1>🛒 Shopping List - Calendar Week ${calendarWeek}</h1>
          <p><strong>Calendar Week ${calendarWeek}</strong> | Generated on ${new Date().toLocaleDateString()}</p>

          <div class="meal-list">
              <h2>📋 This Week's Meals:</h2>
              ${weekMeals.map(meal => `
                  <div class="meal-item">
                      <span>• ${meal.title}</span>
                      <span class="portion-count">(4 portions)</span>
                  </div>
              `).join('')}
          </div>

          <h2>🥘 Shopping List by Category:</h2>
          ${Object.entries(categorizedIngredients)
              .filter(([category, ingredients]) => Object.keys(ingredients).length > 0)
              .map(([category, ingredients]) => `
                  <div class="category-section">
                      <h3>${category}</h3>
                      <div class="ingredients-list">
                          ${Object.entries(ingredients)
                              .sort(([a], [b]) => a.localeCompare(b))
                              .map(([ingredient, amount]) => `
                                  <div class="ingredient">${ingredient}</div>
                                  <div class="amount">${amount}</div>
                              `).join('')}
                      </div>
                  </div>
              `).join('')}

          <p style="margin-top: 40px; font-size: 12px; color: #7f8c8d;">
              Generated by Martha's Meals | All ingredients calculated for 4 portions per meal
          </p>
      </body>
      </html>`;

                  // Create and download PDF
                  const blob = new Blob([pdfContent], { type: 'text/html' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `marthas-meals-shopping-list-week-${calendarWeek}.html`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);

                  // Show success message
                  alert('Shopping list downloaded! The file will open in your browser where you can print it as PDF.');
              }

              function nextWeek() {
                  currentWeek++;

                  if (!allWeeklyMeals[currentWeek]) {
                      // Reset used meals every 4 weeks to ensure variety
                      if (currentWeek % 4 === 0) {
                          usedMeatMeals = [];
                          usedVegetarianMeals = [];
                      }
                      const selectedMeals = generateWeeklyMeals();
                      allWeeklyMeals[currentWeek] = selectedMeals;
                  }

                  displayMeals(allWeeklyMeals[currentWeek]);

                  document.getElementById('prevWeekBtn').style.display = 'inline-block';
                  document.getElementById('nextWeekBtn').style.display = 'inline-block';
                  document.getElementById('randomizeBtn').style.display = 'inline-block';
                  updateWeekDisplay();
              }

              function previousWeek() {
                  if (currentWeek > 0) {
                      currentWeek--;
                      displayMeals(allWeeklyMeals[currentWeek]);

                      document.getElementById('prevWeekBtn').style.display = currentWeek > 0 ? 'inline-block' : 'none';
                      document.getElementById('nextWeekBtn').style.display = 'inline-block';
                      document.getElementById('randomizeBtn').style.display = 'inline-block';
                      updateWeekDisplay();
                  }
              }

              function showFavorites() {
                  if (favorites.length === 0) {
                      alert('No favorite meals yet! Rate some meals with 👍 to add them to favorites.');
                      return;
                  }

                  showListView('favorites');
              }

              function showBanned() {
                  if (banned.length === 0) {
                      alert('No banned meals yet! Rate some meals with 👎 to ban them.');
                      return;
                  }

                  showListView('banned');
              }

              function showListView(type) {
                  const isMainView = document.getElementById('mealsContainer').style.display !== 'none';
                  
                  if (isMainView) {
                      document.getElementById('mealsContainer').style.display = 'none';
                      document.querySelector('.button-container').style.display = 'none';
                      document.getElementById('weekIndicator').style.display = 'none';
                  }

                  document.getElementById('favoritesContainer').style.display = type === 'favorites' ? 'block' : 'none';
                  document.getElementById('bannedContainer').style.display = type === 'banned' ? 'block' : 'none';

                  const allMeals = [...meatMeals, ...vegetarianMeals];
                  const targetMeals = type === 'favorites' ? 
                      allMeals.filter(meal => favorites.includes(meal.title)) :
                      allMeals.filter(meal => banned.includes(meal.title));

                  const gridId = type === 'favorites' ? 'favoritesMealsGrid' : 'bannedMealsGrid';
                  const container = document.getElementById(gridId);

                  container.innerHTML = '';
                  targetMeals.forEach(meal => {
                      const mealCard = document.createElement('div');
                      mealCard.className = 'meal-card';

                      const rating = mealRatings[meal.title] || '';
                      const thumbUpActive = rating === 'up' ? 'active' : '';
                      const thumbDownActive = rating === 'down' ? 'active' : '';

                      mealCard.innerHTML = `
                          <img src="${meal.image}" alt="${meal.title}" class="meal-image">
                          <div class="meal-title">${getFlagForTitle(meal.title)} ${meal.title}</div>
                          <div class="rating-buttons">
                              <button class="thumb-btn thumb-up ${thumbUpActive}" onclick="rateMeal('${meal.title}', 'up')">
                                  👍
                              </button>
                              <button class="thumb-btn thumb-down ${thumbDownActive}" onclick="rateMeal('${meal.title}', 'down')">
                                  👎
                              </button>
                          </div>
                      `;

                      container.appendChild(mealCard);
                  });
              }

              function showMainView() {
                  document.getElementById('mealsContainer').style.display = '';
                  document.querySelector('.button-container').style.display = '';
                  document.getElementById('weekIndicator').style.display = Object.keys(allWeeklyMeals).length > 0 ? 'block' : 'none';
                  document.getElementById('favoritesContainer').style.display = 'none';
                  document.getElementById('bannedContainer').style.display = 'none';
                  document.getElementById('shoppingListContainer').style.display = 'none';
              }

              function saveState() {
                  const state = {
                      currentWeek,
                      allWeeklyMeals,
                      usedMeatMeals,
                      usedVegetarianMeals,
                      favorites,
                      banned,
                      mealRatings,
                      startingCalendarWeek,
                      saveDate: new Date().toISOString()
                  };
                  
                  const stateString = JSON.stringify(state, null, 2);
                  const blob = new Blob([stateString], { type: 'application/json' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `meal-planner-state-${new Date().toISOString().split('T')[0]}.json`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                  
                  alert('State saved successfully! You can now load this state anytime.');
              }

              function loadState() {
                  const input = document.createElement('input');
                  input.type = 'file';
                  input.accept = '.json';
                  input.style.display = 'none';
                  
                  input.onchange = function(event) {
                      const file = event.target.files[0];
                      if (!file) return;
                      
                      const reader = new FileReader();
                      reader.onload = function(e) {
                          try {
                              const state = JSON.parse(e.target.result);
                              
                              // Validate the state object
                              if (!state.allWeeklyMeals || typeof state.currentWeek !== 'number') {
                                  throw new Error('Invalid state file');
                              }
                              
                              // Restore state
                              currentWeek = state.currentWeek || 0;
                              allWeeklyMeals = state.allWeeklyMeals || {};
                              usedMeatMeals = state.usedMeatMeals || [];
                              usedVegetarianMeals = state.usedVegetarianMeals || [];
                              favorites = state.favorites || [];
                              banned = state.banned || [];
                              mealRatings = state.mealRatings || {};
                              startingCalendarWeek = state.startingCalendarWeek || getCurrentWeekNumber();
                              
                              // Update display
                              if (allWeeklyMeals[currentWeek]) {
                                  displayMeals(allWeeklyMeals[currentWeek]);
                                  
                                  // Show navigation buttons
                                  document.getElementById('nextWeekBtn').style.display = 'inline-block';
                                  document.getElementById('prevWeekBtn').style.display = currentWeek > 0 ? 'inline-block' : 'none';
                                  document.getElementById('weekIndicator').style.display = 'block';
                                  document.getElementById('exportBtn').style.display = 'inline-block';
                                  document.getElementById('favoritesBtn').style.display = favorites.length > 0 ? 'inline-block' : 'none';
                                  document.getElementById('bannedBtn').style.display = banned.length > 0 ? 'inline-block' : 'none';
                                  document.getElementById('surpriseBtn').style.display = favorites.length >= 4 ? 'inline-block' : 'none';
                                  document.getElementById('saveBtn').style.display = 'inline-block';
                                  
                                  updateWeekDisplay();
                              }
                              
                              const saveDate = state.saveDate ? new Date(state.saveDate).toLocaleDateString() : 'Unknown date';
                              alert(`State loaded successfully! (Saved on ${saveDate})`);
                              
                          } catch (error) {
                              alert('Error loading state file. Please make sure it\'s a valid meal planner state file.');
                              console.error('Load state error:', error);
                          }
                      };
                      
                      reader.readAsText(file);
                  };
                  
                  document.body.appendChild(input);
                  input.click();
                  document.body.removeChild(input);
              }
    </script>
  </body>
</html>
